import tensorflow as tf
from tensorflow.keras.models import Model, load_model
from tensorflow.keras import preprocessing


# 의도 분류 모델 모듈
class IntentModel:
    def __init__(self, model_name, proprocess):

        # 의도 클래스 별 레이블
        self.labels = {0 : "주문_취소_확인",
                       1 : "배송_비용_질문",
                       2 : "배송_비용_요청",
                       3 : "매장_정보_확인",
                       4 : "제품_품질_비교",
                       5 : "배송_일반_질문",
                       6 : "결제_영수증_요청",
                       7 : "제품_품질_요청",
                       8 : "제품_호환_확인",
                       9 : "포장_일반_질문",
                       10 : "제품_구성_질문",
                       11 : "매장_이용_확인",
                       12 : "구매_제품_요청",
                       13 : "제품_추천_확인",
                       14 : "제품_일반_비교",
                       15 : "구매_오류_요청",
                       16 : "예약_취소_질문",
                       17 : "웹사이트_오류_질문",
                       18 : "제품_용도_확인",
                       19 : "웹사이트_사용_확인",
                       20 : "제품_품질_질문",
                       21 : "제품_입고_요청",
                       22 : "매장_정보_질문",
                       23 : "제품_가격_요청",
                       24 : "제품_호환_요청",
                       25 : "주문_변경_확인",
                       26 : "포장_일반_확인",
                       27 : "제품_원산지_확인",
                       28 : "행사_유형_질문",
                       29 : "행사_날짜_요청",
                       30 : "멤버십_오류_질문",
                       31 : "예약_취소_요청",
                       32 : "교환|반품|환불_시간_질문",
                       33 : "AS_일반_요청",
                       34 : "구매_제품_질문",
                       35 : "제품_정보_비교",
                       36 : "제품_용도_질문",
                       37 : "제품_소재_확인",
                       38 : "행사_기간_요청",
                       39 : "제품_품질_확인",
                       40 : "매장_구조_질문",
                       41 : "구매_변경_요청",
                       42 : "예약_방법_확인",
                       43 : "행사_일반_질문",
                       44 : "제품_일반_요청",
                       45 : "구매_예약_질문",
                       46 : "부가서비스_방법_요청",
                       47 : "결제_추가_요청",
                       48 : "멤버십_가입_질문",
                       49 : "제품_날짜_비교",
                       50 : "AS_비용_질문",
                       51 : "제품_방법_요청",
                       52 : "구매_변경_질문",
                       53 : "교환|반품|환불_시간_확인",
                       54 : "매장_이용_질문",
                       55 : "결제_재결제_요청",
                       56 : "배송_방법_비교",
                       57 : "제품_원산지_질문",
                       58 : "교환|반품|환불_일반_확인",
                       59 : "AS_방법_요청",
                       60 : "제품_정보_요청",
                       61 : "결제_오류_확인",
                       62 : "배송_날짜_질문",
                       63 : "배송_오류_확인",
                       64 : "부가서비스_날짜_질문",
                       65 : "제품_재고_요청",
                       66 : "배송_오류_질문",
                       67 : "행사_날짜_질문",
                       68 : "구매_변경_확인",
                       69 : "결제_취소_질문",
                       70 : "제품_시용_질문",
                       71 : "예약_비용_요청",
                       72 : "제품_일반_질문",
                       73 : "제품_구성_확인",
                       74 : "포장_일반_요청",
                       75 : "제품_호환_비교",
                       76 : "교환|반품|환불_비용_질문",
                       77 : "구매_추가_확인",
                       78 : "행사_유형_요청",
                       79 : "제품_방법_질문",
                       80 : "제품_입고_질문",
                       81 : "제품_구성_요청",
                       82 : "제품_정보_확인",
                       83 : "제품_커스텀_질문",
                       84 : "AS_날짜_질문",
                       85 : "매장_부대시설_요청",
                       86 : "포장_비용_질문",
                       87 : "제품_가격_확인",
                       88 : "결제_할인_질문",
                       89 : "결제_수단_질문",
                       90 : "부가서비스_비용_질문",
                       91 : "주문_비품_확인",
                       92 : "제품_재고_질문",
                       93 : "구매_추가_요청",
                       94 : "주문_오류_요청",
                       95 : "웹사이트_오류_확인",
                       96 : "결제_시기_확인",
                       97 : "배송_지역_확인",
                       98 : "배송_방법_요청",
                       99 : "제품_시용_요청",
                       100 : "행사_기간_확인",
                       101 : "행사_정보_요청",
                       102 : "행사_일반_확인",
                       103 : "AS_시간_질문",
                       104 : "제품_날짜_질문",
                       105 : "교환|반품|환불_날짜_질문",
                       106 : "결제_시기_질문",
                       107 : "제품_용도_비교",
                       108 : "행사_정보_확인",
                       109 : "멤버십_적립_질문",
                       110 : "제품_재고_확인",
                       111 : "결제_방식_요청",
                       112 : "제품_추천_질문",
                       113 : "배송_지역_요청",
                       114 : "주문_추가_질문",
                       115 : "주문_변경_질문",
                       116 : "제품_추천_요청",
                       117 : "결제_추가_확인",
                       118 : "결제_취소_요청",
                       119 : "행사_유형_비교",
                       120 : "제품_방법_확인",
                       121 : "AS_방법_질문",
                       122 : "제품_불량_질문",
                       123 : "예약_방법_요청",
                       124 : "교환|반품|환불_방법_확인",
                       125 : "주문_추가_요청",
                       126 : "제품_정보_질문",
                       127 : "구매_취소_질문",
                       128 : "결제_수단_요청",
                       129 : "부가서비스_날짜_요청",
                       130 : "결제_일반_확인",
                       131 : "멤버십_적립_확인",
                       132 : "교환|반품|환불_일반_비교",
                       133 : "주문_취소_요청",
                       134 : "멤버십_가입_확인",
                       135 : "예약_변경_질문",
                       136 : "결제_오류_질문",
                       137 : "웹사이트_사용_질문",
                       138 : "멤버십_사용_질문",
                       139 : "제품_가격_비교",
                       140 : "제품_날짜_확인",
                       141 : "AS_비용_요청",
                       142 : "배송_방법_확인",
                       143 : "제품_구매_요청",
                       144 : "예약_변경_요청",
                       145 : "결제_영수증_질문",
                       146 : "제품_소재_요청",
                       147 : "포장_방식_질문",
                       148 : "결제_추가_질문",
                       149 : "부가서비스_방법_질문",
                       150 : "배송_택배사_질문",
                       151 : "주문_비품_질문",
                       152 : "멤버십_일반_질문",
                       153 : "결제_일반_질문",
                       154 : "주문_제품_요청",
                       155 : "교환|반품|환불_일반_질문",
                       156 : "제품_구성_비교",
                       157 : "제품_소재_비교",
                       158 : "제품_소재_질문",
                       159 : "행사_유형_확인",
                       160 : "예약_비용_질문",
                       161 : "AS_날짜_요청",
                       162 : "제품_원산지_비교",
                       163 : "구매_취소_확인",
                       164 : "교환|반품|환불_방법_요청",
                       165 : "결제_방식_질문",
                       166 : "결제_취소_확인",
                       167 : "구매_예약_요청",
                       168 : "제품_추천_비교",
                       169 : "제품_불량_요청",
                       170 : "교환|반품|환불_비용_확인",
                       171 : "구매_취소_요청",
                       172 : "AS_일반_질문",
                       173 : "행사_기간_질문",
                       174 : "배송_지역_질문",
                       175 : "주문_비품_요청",
                       176 : "교환|반품|환불_일반_요청",
                       177 : "배송_날짜_확인",
                       178 : "주문_취소_질문",
                       179 : "교환|반품|환불_방법_질문",
                       180 : "교환|반품|환불_시간_요청",
                       181 : "배송_일반_확인",
                       182 : "예약_변경_확인",
                       183 : "주문_제품_질문",
                       184 : "제품_호환_질문",
                       185 : "매장_부대시설_확인",
                       186 : "AS_일반_확인",
                       187 : "매장_이용_요청",
                       188 : "부가서비스_비용_요청",
                       189 : "포장_방식_확인",
                       190 : "배송_방법_질문",
                       191 : "포장_방식_요청",
                       192 : "제품_방법_비교",
                       193 : "제품_일반_확인",
                       194 : "구매_오류_질문",
                       195 : "멤버십_일반_요청",
                       196 : "예약_방법_질문",
                       197 : "주문_추가_확인",
                       198 : "결제_방식_확인",
                       199 : "결제_할인_확인",
                       200 : "행사_정보_질문",
                       201 : "제품_가격_질문",
                       202 : "결제_재결제_질문",
                       203 : "매장_부대시설_질문",
                       204 : "제품_입고_확인",
                       205 : "배송_택배사_확인",
                       206 : "제품_재고_비교",
                       207 : "제품_날짜_요청",
                       208 : "배송_오류_요청",
                       209 : "배송_일반_요청",
                       210 : "행사_날짜_확인",
                       211 : "배송_비용_확인",
                       212 : "제품_구매_질문",
                       213 : "제품_커스텀_요청",
                       214 : "주문_변경_요청",
                       215 : "주문_제품_확인",
                       216 : "교환|반품|환불_비용_요청",
                       217 : "배송_날짜_요청",
                       218 : "행사_일반_요청",
                       219 : "제품_불량_확인",
                       220 : "주문_오류_질문"}

        # 의도 분류 모델 불러오기
        self.model = load_model(model_name)

        # 챗봇 Preprocess 객체
        self.p = proprocess


    # 의도 클래스 예측
    def predict_class(self, query):
        # 형태소 분석
        pos = self.p.pos(query)

        # 문장내 키워드 추출(불용어 제거)
        keywords = self.p.get_keywords(pos, without_tag=True)
        sequences = [self.p.get_wordidx_sequence(keywords)]

        # 단어 시퀀스 벡터 크기
        from config.GlobalParams import MAX_SEQ_LEN

        # 패딩처리
        padded_seqs = preprocessing.sequence.pad_sequences(sequences, maxlen=MAX_SEQ_LEN, padding='post')

        predict = self.model.predict(padded_seqs)
        predict_class = tf.math.argmax(predict, axis=1)
        return predict_class.numpy()[0]
